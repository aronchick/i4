# Pipeline: IoT Sensor Batched Generator
# Self-contained pipeline that generates sensor data, batches, and writes to files
#
# Usage:
#   expanso-edge run pipelines/sensor-batched.yaml
#
#   # Custom settings
#   BATCH_SIZE=500 BATCH_PERIOD=5s OUTPUT_DIR=./data expanso-edge run pipelines/sensor-batched.yaml
#
# Configuration:
#   - GEN_INTERVAL: Time between sensor readings (default: 100us for ~10k/sec)
#   - BATCH_SIZE: Records per batch file (default: 1000)
#   - BATCH_PERIOD: Max time before flushing batch (default: 10s)
#   - OUTPUT_DIR: Directory for batch files (default: ./output)

input:
  batched:
    child:
      generate:
        interval: "${GEN_INTERVAL:100us}"
        count: 0  # Infinite
        mapping: |
          let sensor_types = ["pressure", "temperature", "flow_rate", "vibration", "corrosion", "humidity", "gas_detector", "valve_position"]
          let units = {"pressure": "psi", "temperature": "fahrenheit", "flow_rate": "bbl/hr", "vibration": "mm/s", "corrosion": "mpy", "humidity": "percent", "gas_detector": "ppm", "valve_position": "percent"}
          let ranges = {"pressure": [200, 1500], "temperature": [-20, 180], "flow_rate": [0, 50000], "vibration": [0, 25], "corrosion": [0, 50], "humidity": [0, 100], "gas_detector": [0, 1000], "valve_position": [0, 100]}
          let pipelines = ["PIPE-TX-001", "PIPE-TX-002", "PIPE-OK-001", "PIPE-LA-001", "PIPE-NM-001", "PIPE-CO-001", "PIPE-WY-001", "PIPE-ND-001"]
          let statuses = ["normal", "normal", "normal", "normal", "warning", "maintenance"]
          let alerts = ["", "", "", "", "", "low", "medium", "high"]

          let type_idx = random_int(max: 8)
          let sensor_type = $sensor_types.index($type_idx)
          let range = $ranges.get($sensor_type)
          let min_val = $range.index(0)
          let max_val = $range.index(1)
          let base_value = $min_val + (random_int(max: 1000000) / 1000000.0) * ($max_val - $min_val)

          # 2% chance of anomaly (exceed max by up to 20%)
          let is_anomaly = random_int(max: 100) < 2
          let value = if $is_anomaly { $max_val + (random_int(max: 1000000) / 1000000.0) * $max_val * 0.2 } else { $base_value }

          root = {
            "sensor_id": "SNS-%s-%04d".format($sensor_type.slice(0, 3), random_int(max: 10000)),
            "timestamp": now().ts_format("2006-01-02T15:04:05.000000Z"),
            "type": $sensor_type,
            "value": $value,
            "unit": $units.get($sensor_type),
            "location": {
              "lat": 25.0 + (random_int(max: 1000000) / 1000000.0) * 20,
              "lon": -105.0 + (random_int(max: 1000000) / 1000000.0) * 15,
              "mile_post": (random_int(max: 1000000) / 1000000.0) * 500
            },
            "pipeline_id": $pipelines.index(random_int(max: 8)),
            "status": $statuses.index(random_int(max: 6)),
            "quality_score": 0.85 + (random_int(max: 1000000) / 1000000.0) * 0.15,
            "alert_level": $alerts.index(random_int(max: 8))
          }
    policy:
      count: ${BATCH_SIZE:1000}
      period: "${BATCH_PERIOD:10s}"
      processors:
        - archive:
            format: json_array

output:
  file:
    path: '${OUTPUT_DIR:./output}/batch_${! timestamp_unix_nano() }.json'
    codec: all-bytes
