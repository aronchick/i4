# Job: IoT Sensor File to Batched Output with Lineage & Validation
# Reads sensor JSONL, enriches, validates, batches with summaries
#
# Usage:
#   expanso-cli job deploy jobs/sensor-batched-enriched-job.yaml
#
# Prerequisites:
#   Run sensor-gen binary on edge node to generate data:
#   ./sensor-gen -d 60s -o /data/sensors/input.jsonl
#
# Configuration (set on edge nodes):
#   - INPUT_FILE: Path to sensor JSONL (default: /data/sensors/input.jsonl)
#   - BATCH_SIZE: Records per batch (default: 1000)
#   - BATCH_PERIOD: Max batch time (default: 10s)
#   - OUTPUT_DIR: Output directory (default: /data/sensors/batched)
#   - EDGE_NODE_ID: Node identifier (default: hostname)

name: sensor-batched-enriched
type: pipeline

selector:
  match_labels:
    role: edge-processor

config:
  input:
    batched:
      child:
        file:
          paths:
            - "${INPUT_FILE:/data/sensors/input.jsonl}"
          scanner:
            lines: {}
      policy:
        count: ${BATCH_SIZE:1000}
        period: "${BATCH_PERIOD:10s}"
        processors:
          - mapping: |
              root = this
              root.lineage = {
                "edge_node": env("EDGE_NODE_ID").or(env("HOSTNAME")).or("unknown"),
                "pipeline": "sensor-batched-enriched",
                "ingested_at": now().ts_format("2006-01-02T15:04:05.000Z")
              }

              let is_anomaly = false
              let anomaly_reasons = []
              let is_anomaly = if this.type == "pressure" && this.value > 1500 { true } else { $is_anomaly }
              let anomaly_reasons = if this.type == "pressure" && this.value > 1500 { $anomaly_reasons.append("pressure_exceeded") } else { $anomaly_reasons }
              let is_anomaly = if this.type == "temperature" && (this.value > 180 || this.value < -20) { true } else { $is_anomaly }
              let anomaly_reasons = if this.type == "temperature" && (this.value > 180 || this.value < -20) { $anomaly_reasons.append("temperature_out_of_range") } else { $anomaly_reasons }
              let is_anomaly = if this.type == "flow_rate" && this.value > 50000 { true } else { $is_anomaly }
              let anomaly_reasons = if this.type == "flow_rate" && this.value > 50000 { $anomaly_reasons.append("flow_rate_exceeded") } else { $anomaly_reasons }
              let is_anomaly = if this.quality_score < 0.8 { true } else { $is_anomaly }
              let anomaly_reasons = if this.quality_score < 0.8 { $anomaly_reasons.append("low_quality_score") } else { $anomaly_reasons }

              root.data_quality = {
                "is_anomaly": $is_anomaly,
                "anomaly_reasons": $anomaly_reasons,
                "validated": true
              }

          - archive:
              format: json_array
          - mapping: |
              let records = this
              let count = $records.length()
              let anomaly_count = $records.filter(r -> r.data_quality.is_anomaly == true).length()

              root = {
                "batch_meta": {
                  "record_count": $count,
                  "anomaly_count": $anomaly_count,
                  "anomaly_rate_pct": if $count > 0 { (($anomaly_count / $count) * 100).round() } else { 0 },
                  "batch_time": now().ts_format("2006-01-02T15:04:05.000Z"),
                  "edge_node": env("EDGE_NODE_ID").or(env("HOSTNAME")).or("unknown"),
                  "pipeline": "sensor-batched-enriched"
                },
                "records": $records
              }

  output:
    file:
      path: '${OUTPUT_DIR:/data/sensors/batched}/batch_${! timestamp_unix_nano() }.json'
      codec: all-bytes
