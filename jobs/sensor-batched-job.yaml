# Job: IoT Sensor File to Batched Output
# Reads sensor JSONL from file, batches, writes to output files
#
# Usage:
#   expanso-cli job deploy jobs/sensor-batched-job.yaml
#
# Prerequisites:
#   Run sensor-gen binary on edge node to generate data:
#   ./sensor-gen -d 60s -o /data/sensors/input.jsonl
#
# Configuration (set on edge nodes):
#   - INPUT_FILE: Path to sensor JSONL (default: /data/sensors/input.jsonl)
#   - BATCH_SIZE: Records per batch (default: 1000)
#   - BATCH_PERIOD: Max batch time (default: 10s)
#   - OUTPUT_DIR: Output directory (default: /data/sensors/batched)

name: sensor-batched
type: pipeline

selector:
  match_labels:
    role: edge-processor

config:
  input:
    batched:
      child:
        file:
          paths:
            - "${INPUT_FILE:/data/sensors/input.jsonl}"
          scanner:
            lines: {}
      policy:
        count: ${BATCH_SIZE:1000}
        period: "${BATCH_PERIOD:10s}"
        processors:
          - archive:
              format: json_array

  output:
    file:
      path: '${OUTPUT_DIR:/data/sensors/batched}/batch_${! timestamp_unix_nano() }.json'
      codec: all-bytes
