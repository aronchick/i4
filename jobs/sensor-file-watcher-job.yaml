# Job: IoT Sensor File Watcher
# Watches for sensor JSONL files on edge nodes and processes them
#
# Usage:
#   expanso-cli job deploy jobs/sensor-file-watcher-job.yaml
#
# Configuration (set on edge nodes):
#   - SENSOR_DATA_DIR: Directory to watch (default: /data/sensors)
#   - FILE_PATTERN: Glob pattern for files (default: *.jsonl)
#
# This job watches for new .jsonl files in the configured directory,
# processes them with lineage/validation, and outputs to stdout.
# Combine with fan_out output to send to multiple destinations.

name: sensor-file-watcher
type: pipeline

selector:
  match_labels:
    role: edge-processor
    input: file
    # Uncomment for specific targeting:
    # env: production

config:
  input:
    label: "sensor_file_watcher"
    file:
      paths:
        - "${SENSOR_DATA_DIR:/data/sensors}/${FILE_PATTERN:*.jsonl}"
      scanner:
        lines: {}
      # Delete files after processing (set to false to keep)
      delete_on_finish: false

  pipeline:
    processors:
      - mapping: |
          root = this

          # Add lineage metadata
          root.lineage = {
            "edge_node": env("EDGE_NODE_ID").or(env("HOSTNAME")).or("unknown"),
            "pipeline": "sensor-file-watcher",
            "pipeline_version": "1.0.0",
            "ingested_at": now().ts_format("2006-01-02T15:04:05.000Z"),
            "source_path": env("SENSOR_DATA_DIR").or("/data/sensors")
          }

          # Anomaly detection
          let is_anomaly = false
          let anomaly_reasons = []

          let is_anomaly = if this.type == "pressure" && this.value > 1500 { true } else { $is_anomaly }
          let anomaly_reasons = if this.type == "pressure" && this.value > 1500 { $anomaly_reasons.append("pressure_exceeded") } else { $anomaly_reasons }

          let is_anomaly = if this.type == "temperature" && (this.value > 180 || this.value < -20) { true } else { $is_anomaly }
          let anomaly_reasons = if this.type == "temperature" && (this.value > 180 || this.value < -20) { $anomaly_reasons.append("temperature_out_of_range") } else { $anomaly_reasons }

          let is_anomaly = if this.type == "flow_rate" && this.value > 50000 { true } else { $is_anomaly }
          let anomaly_reasons = if this.type == "flow_rate" && this.value > 50000 { $anomaly_reasons.append("flow_rate_exceeded") } else { $anomaly_reasons }

          let is_anomaly = if this.quality_score < 0.8 { true } else { $is_anomaly }
          let anomaly_reasons = if this.quality_score < 0.8 { $anomaly_reasons.append("low_quality_score") } else { $anomaly_reasons }

          root.data_quality = {
            "is_anomaly": $is_anomaly,
            "anomaly_reasons": $anomaly_reasons,
            "validated": true
          }

  output:
    stdout:
      codec: lines
